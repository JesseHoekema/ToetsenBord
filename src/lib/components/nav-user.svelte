<script lang="ts">
    import DotsVerticalIcon from "@lucide/svelte/icons/log-out";
    import * as Avatar from "$lib/components/ui/avatar/index.js";
    import * as DropdownMenu from "$lib/components/ui/dropdown-menu/index.js";
    import * as Sidebar from "$lib/components/ui/sidebar/index.js";
    import LogoutIcon from "@lucide/svelte/icons/log-out";
    import MoonIcon from '@lucide/svelte/icons/moon'
    import SunIcon from '@lucide/svelte/icons/sun'
    import { goto } from "$app/navigation";
    import { mode, toggleMode } from "mode-watcher";
    import { Item } from "./ui/breadcrumb";
    let { user }: { user: { name: string; email: string; avatar: string } } =
        $props();
    const sidebar = Sidebar.useSidebar();

    async function logoutUser() {
        try {
        	const res = await fetch('/api/auth/logout', {
        		method: 'POST',
        		credentials: 'include'
        	});
        	if (res.redirected) {
        		window.location.href = res.url;
        	} else if (res.status === 200 || res.status === 302) {
        		window.location.href = '/sign-in';
        	}
        } catch (err) {
        	console.error('Logout failed:', err);
        }
    }
    async function somtodayIntegration() {
        goto("/somtoday-integration");
    }
</script>

<Sidebar.Menu>
    <Sidebar.MenuItem>
        <DropdownMenu.Root>
            <DropdownMenu.Trigger>
                {#snippet child({ props })}
                    <Sidebar.MenuButton
                        {...props}
                        size="lg"
                        class="data-[state=open]:bg-sidebar-accent data-[state=open]:text-sidebar-accent-foreground"
                    >
                        <Avatar.Root class="size-8 rounded-lg">
                            {#if user.avatar !== ""}
                            <img src={user.avatar} alt="pfp" class="object-cover w-full h-full">
                            {:else}
                            <Avatar.Fallback class="rounded-lg"
                                >{(user.name || "")
                                    .split(" ")
                                    .slice(0, 2)
                                    .map((w) => w[0])
                                    .join("")}</Avatar.Fallback
                            >
                            {/if}
                        </Avatar.Root>
                        <div
                            class="grid flex-1 text-left text-sm leading-tight"
                        >
                            <span class="truncate font-medium">{user.name}</span
                            >
                            <span
                                class="text-muted-foreground truncate text-xs"
                            >
                                {user.email}
                            </span>
                        </div>
                    </Sidebar.MenuButton>
                {/snippet}
            </DropdownMenu.Trigger>
            <DropdownMenu.Content class="w-56" align="start" sideOffset={8}>
                <DropdownMenu.Item
                    class="cursor-pointer"
                    onclick={somtodayIntegration}
                >
                    <div class="mr-2 text-white">
                        <svg
                            width="6174"
                            height="6722"
                            viewBox="0 0 6174 6722"
                            fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <g clip-path="url(#clip0_224_606)">
                                <path
                                    d="M2746.76 0.657232C2609.36 8.35346 2486.59 88.7885 2425.3 211.177C2403.43 254.821 2391.7 295.648 2385.69 349.146C2384.94 356.373 2384.47 431.646 2384 630.716L2383.44 902.43L2381.37 916.509C2374.9 961.56 2362.98 1000.42 2344.02 1038.15C2314.45 1097.28 2270.25 1147.58 2215.53 1184.38C2157.9 1223.14 2094.07 1244.82 2024.06 1249.23C2014.48 1249.79 1883.93 1250.17 1661.29 1250.17C1437.63 1250.17 1309.51 1250.54 1302.29 1251.11C1178.11 1261.43 1068.95 1329.2 1004.57 1435.82C980.727 1475.24 964.208 1519.16 956.042 1564.59C950.129 1597.25 950.504 1582.51 949.847 1817.06C949.284 2010.41 949.096 2032.65 947.689 2043.26C941.306 2090.65 930.7 2127.44 912.398 2165.74C857.115 2281.37 745.705 2362.74 619.466 2379.73C613.553 2380.48 607.452 2381.42 605.857 2381.7C604.355 2381.98 547.946 2382.55 480.556 2383.02C347.746 2383.77 349.06 2383.67 316.773 2389.21C218.128 2406.29 129.526 2462.42 70.301 2545.58C45.7101 2580.11 25.4367 2622.82 14.1737 2663.83C8.35447 2685.14 5.63258 2699.69 1.69053 2729.82C0.188799 2741.36 -0.562067 3905.09 0.939666 3930.43C3.47384 3973.88 11.6395 4011.43 26.9384 4050.19C76.214 4175.39 189.126 4266.62 321.184 4287.83C349.623 4292.34 348.403 4292.34 476.332 4293C606.044 4293.65 602.853 4293.56 631.668 4298.63C733.879 4316.65 826.142 4377.28 883.677 4464.28C919.156 4517.78 940.18 4577.94 946.093 4642.61C946.656 4649.18 947.032 4734.03 947.032 4873.97C947.032 5093.68 947.407 5124.19 950.317 5146.62C963.363 5247.52 1013.2 5336.68 1091.76 5399.28C1142.35 5439.64 1202.42 5466.48 1266.34 5477.46C1284.92 5480.56 1303.51 5482.16 1334.01 5483.1C1381.41 5484.5 1411.35 5489.38 1449.92 5501.96C1493.38 5516.23 1533.93 5538.19 1570.25 5567.19C1586.49 5580.24 1615.87 5609.52 1628.82 5625.76C1676.78 5685.92 1705.03 5756.12 1711.98 5832.71C1712.54 5839.28 1712.92 5932.67 1712.92 6089.88C1712.92 6334.84 1713.29 6361.69 1716.2 6385.62C1731.97 6513.26 1810.15 6624.01 1925.69 6681.92C1964.55 6701.45 2006.6 6713.84 2054.56 6719.84C2067.42 6721.44 2081.78 6721.53 2302.35 6721.53C2522.91 6721.53 2537.27 6721.44 2550.13 6719.84C2599.69 6713.65 2640.33 6701.45 2682 6680.23C2770.98 6635 2838.75 6556.72 2871.03 6461.74C2879.01 6438.18 2884.55 6413.49 2889.15 6381.3C2889.99 6375.29 2890.37 6285.76 2890.84 6017.61C2891.31 5683.2 2891.49 5661.23 2893.09 5651.66C2900.32 5606.89 2919.65 5569.26 2951 5538.94C3039.32 5453.44 3182.36 5469.11 3250.41 5571.79C3265.71 5594.78 3276.22 5622.28 3280.91 5651.66C3282.51 5661.23 3282.7 5683.2 3283.17 6017.61C3283.63 6285.76 3284.01 6375.29 3284.85 6381.3C3289.45 6413.49 3294.99 6438.18 3302.97 6461.74C3335.35 6556.72 3402.93 6634.9 3492 6680.23C3533.58 6701.45 3574.22 6713.65 3623.87 6719.84C3636.73 6721.44 3651.09 6721.53 3871.66 6721.53C4092.22 6721.53 4106.58 6721.44 4119.44 6719.84C4183.45 6711.77 4236.01 6692.91 4286.98 6659.59C4381.87 6597.55 4444 6497.97 4457.8 6385.62C4460.71 6361.69 4461.09 6334.84 4461.09 6089.88C4461.09 5932.67 4461.46 5839.28 4462.03 5832.71C4468.97 5756.12 4497.22 5685.92 4545.18 5625.76C4558.14 5609.52 4587.51 5580.24 4603.75 5567.19C4640.07 5538.19 4680.62 5516.23 4724.08 5501.96C4762.65 5489.38 4792.59 5484.5 4839.99 5483.1C4870.5 5482.16 4889.08 5480.56 4907.66 5477.46C4997.39 5462.07 5076.99 5416.55 5136.59 5346.35C5183.8 5290.78 5214.02 5221.52 5223.69 5146.62C5226.6 5124.19 5226.97 5093.68 5226.97 4873.97C5226.97 4734.03 5227.35 4649.18 5227.91 4642.61C5233.82 4577.94 5254.85 4517.78 5290.33 4464.28C5347.86 4377.28 5440.12 4316.65 5542.33 4298.63C5571.15 4293.56 5567.96 4293.65 5697.67 4293C5825.6 4292.34 5824.38 4292.34 5852.82 4287.83C5984.88 4266.62 6097.79 4175.39 6147.06 4050.19C6162.36 4011.43 6170.53 3973.88 6173.06 3930.43C6174.56 3905.09 6173.81 2741.36 6172.31 2729.82C6169.87 2710.76 6168.18 2700.16 6165.93 2689.18C6136.74 2546.23 6027.11 2431.35 5885.39 2395.22C5869.06 2391.09 5848.88 2387.52 5829.54 2385.27C5817.81 2383.86 5798.85 2383.58 5693.45 2383.02C5626.06 2382.55 5569.74 2381.98 5568.15 2381.7C5566.64 2381.42 5560.45 2380.48 5554.54 2379.73C5428.3 2362.74 5316.89 2281.37 5261.6 2165.74C5243.3 2127.44 5232.7 2090.65 5226.31 2043.26C5224.91 2032.65 5224.72 2010.59 5224.16 1817.53C5223.5 1582.89 5223.87 1596.87 5217.96 1564.59C5198.34 1457.5 5135.18 1364.67 5042.82 1307.33C4991.39 1275.42 4933.1 1256.27 4871.72 1251.11C4864.49 1250.54 4736.37 1250.17 4512.71 1250.17C4290.08 1250.17 4159.52 1249.79 4149.95 1249.23C4096.82 1245.85 4048.3 1232.9 4002.03 1209.81C3983.82 1200.61 3974.24 1195.07 3957.72 1183.91C3902.91 1146.83 3859.46 1097.09 3829.61 1037.49C3811.02 1000.42 3799.1 961.278 3792.63 916.509L3790.56 902.43L3790 630.716C3789.53 431.834 3789.06 356.373 3788.31 349.146C3782.3 295.648 3770.57 254.821 3748.7 211.177C3698.21 110.375 3604.91 36.6043 3494.82 10.5122C3480.46 7.03947 3464.97 4.31763 3447.42 2.15894C3435.78 0.751089 3407.06 0.563376 3093.57 0.469519C2905.95 0.375663 2749.86 0.469519 2746.76 0.657232ZM4735.9 3408.96C4795.13 3415.34 4846 3451.2 4871.62 3504.6C4882.51 3527.22 4887.2 3546.74 4887.86 3572.37C4888.71 3599.96 4886.36 3611.97 4871.25 3658.06C4826.29 3794.8 4767.16 3917.48 4689.63 4034.42C4632.94 4119.92 4574.37 4192.1 4502.38 4265.21C4284.91 4485.87 3998.93 4639.42 3693.8 4699.39C3519.31 4733.65 3338.92 4737.12 3162.56 4709.62C3130.46 4704.65 3088.78 4696.67 3057.44 4689.54C3012.38 4679.31 2949.03 4661.76 2932.04 4654.81C2893.28 4638.95 2861.65 4609.1 2843.44 4571.28C2820.91 4524.54 2820.91 4471.51 2843.44 4424.58C2852.73 4405.15 2863.15 4390.98 2879.76 4375.12C2892.62 4362.73 2904.35 4354.47 2920.4 4346.49C2948.75 4332.41 2978.5 4326.22 3007.5 4328.57C3023.55 4329.88 3031.06 4331.48 3059.13 4339.55C3238.21 4390.89 3417.95 4401.68 3597.12 4371.74C3793.94 4338.89 3984.66 4254.7 4144.6 4130.25C4208.04 4080.88 4270.18 4021.19 4322.18 3959.8C4385.53 3884.81 4437.34 3805.88 4481.27 3717.19C4510.55 3658.15 4532.7 3603.24 4551.66 3543.36C4559.64 3517.93 4562.27 3510.98 4568.93 3498.41C4592.3 3454.01 4634.54 3422.19 4684 3411.78C4701.55 3408.02 4719.01 3407.08 4735.9 3408.96Z"
                                    fill="currentColor"
                                />
                            </g>
                            <defs>
                                <clipPath id="clip0_224_606">
                                    <rect
                                        width="6174"
                                        height="6722"
                                        fill="CurrentColor"
                                    />
                                </clipPath>
                            </defs>
                        </svg>
                    </div>
                    Somtoday Integratie
                </DropdownMenu.Item>
                <DropdownMenu.Item onclick={toggleMode}>
                    {#if mode.current === 'dark'}
                        <SunIcon class="mr-2" />
                        Licht
                    {:else}
                        <MoonIcon class="mr-2" />
                        Donker
                    {/if}
                </DropdownMenu.Item>
                <DropdownMenu.Item class="cursor-pointer" onclick={logoutUser}>
                    <LogoutIcon class="mr-2" /> Uitloggen
                </DropdownMenu.Item>
            </DropdownMenu.Content>
        </DropdownMenu.Root>
    </Sidebar.MenuItem>
</Sidebar.Menu>
